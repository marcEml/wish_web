{% extends 'base.html.twig' %}

{% block title %}Hello SharingController!{% endblock %}

{% block nav %}
  {% include 'navbar.html.twig' %}
{% endblock %}

{% block body %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="p-4 w-75 m-auto">
    <a class="btn btn-success mb-4" href="{{ path('app_home') }}">Retourner à l'accueil</a>

    <h3 class="py-4 fw-bold">La WishList <span class="text-primary">{{ wishlist.title }}</span> a été partagée avec vous</h3>

    <!-- Sorting Select -->
    <div class="mb-4">
        <label for="sortSelect" class="form-label fw-bold">Trier par prix :</label>
        <select id="sortSelect" class="form-select w-50">
            <option value="asc">Du moins cher au plus cher</option>
            <option value="desc">Du plus cher au moins cher</option>
        </select>
    </div>

    <div class="container text-center">
        <div class="row row-cols-2" id="items-container">
            {% for item in items %}
                <div class="card mx-1 mb-4 item-card" style="width: 18rem;"
                     data-id="{{ item.id }}"
                     data-price="{{ item.price }}"
                     data-external-link="{{ item.externalLink }}">
                    <img src="https://t3.ftcdn.net/jpg/06/50/41/82/360_F_650418284_gH1jJH1H9A0ErBxosY1f6ofyPrnCiFie.jpg" class="card-img-top" alt="...">
                    <div class="card-body">
                        <h5 class="card-title">{{ item.name }}</h5>
                        <p class="card-subtitle">{{ item.description }}</p>
                        <p class="card-text text-success">{{ item.price }}€</p>
                        <a href="#" class="btn btn-primary acheter-btn" data-bs-toggle="modal" data-bs-target="#buyModal">Acheter</a>
                    </div>
                </div>
            {% else %}
                <p>Cette wishlist est vide pour le moment.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="buyModal" tabindex="-1" aria-labelledby="buyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="buyModalLabel">Confirmer l'achat</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        Vous pouvez soit rejoindre le site sur lequel vous pouvez acheter le cadeau ou soit téléverser la preuve de paiement.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="redirect-buy">Acheter le cadeau</button>
        <button type="button" class="btn btn-primary" id="redirect-upload">Téléverser la preuve de paiement</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let selectedCard = null;
        let externalLink = '#';

        // When 'Acheter' button is clicked, store the selected card and its external link
        document.querySelectorAll('.acheter-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                selectedCard = this.closest('.item-card');
                externalLink = selectedCard.getAttribute('data-external-link');
            });
        });

        // Handle redirection to external link
        document.getElementById('redirect-buy').addEventListener('click', function () {
            if (externalLink && externalLink !== '#') {
                window.open(externalLink, '_blank');
            } else {
                alert('Lien externe indisponible');
            }
        });

        // Handle redirection to the upload proof route
        document.getElementById('redirect-upload').addEventListener('click', function () {
            if (selectedCard) {
                const itemId = selectedCard.getAttribute('data-id');
                // Build the URL dynamically using the item ID
                window.location.href = '{{ path("app_purchase_new", {"id": "ITEM_ID_PLACEHOLDER"}) }}'.replace('ITEM_ID_PLACEHOLDER', itemId);
            } else {
                alert('Veuillez d\'abord sélectionner un cadeau.');
            }
        });

        // Sorting Logic
        const sortSelect = document.getElementById('sortSelect');
        const itemsContainer = document.getElementById('items-container');

        sortSelect.addEventListener('change', function () {
            const order = this.value;
            const items = Array.from(itemsContainer.querySelectorAll('.item-card'));

            items.sort((a, b) => {
                const priceA = parseFloat(a.getAttribute('data-price'));
                const priceB = parseFloat(b.getAttribute('data-price'));
                return order === 'asc' ? priceA - priceB : priceB - priceA;
            });

            // Clear container and append sorted items
            itemsContainer.innerHTML = '';
            items.forEach(item => itemsContainer.appendChild(item));
        });
    });
</script>

{% endblock %}
